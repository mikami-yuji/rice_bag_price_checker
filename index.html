<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>米袋価格メリット計算ツール</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        @media (min-width: 992px) {
            .main-layout {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
            .container {
                margin-bottom: 0;
            }
            .results {
                margin-top: 0;
            }
        }
        .container {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .input-section {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-section:last-child {
            margin-bottom: 0;
        }
        .input-section h3 {
            margin-top: 0;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #4CAF50;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        .price-layout {
            grid-template-columns: 1fr;
        }
        .price-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .price-column h4 {
            margin: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 1em;
            color: #4CAF50;
        }
        @media (min-width: 992px) {
            .price-layout {
                grid-template-columns: 1fr 1fr 1fr;
                align-items: start;
            }
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        .unit-spec {
            font-size: 0.8em;
            font-weight: normal;
            color: #666;
            margin-left: 8px;
        }
        input, select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        input[type="radio"] {
            width: auto;
        }
        .stepper {
            display: flex;
        }
        .stepper input {
            text-align: center;
            border-left: none;
            border-right: none;
            border-radius: 0;
            flex-grow: 1;
            width: 80px;
        }
        .stepper button, .reset-button {
            width: 44px;
            flex-shrink: 0;
            padding: 0;
            margin: 0;
            font-size: 1.5em;
            line-height: 1;
            background-color: #f8f9fa;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .stepper button:hover, .reset-button:hover {
            background-color: #e9ecef;
        }
        .stepper button:first-of-type {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        .stepper button:last-of-type {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .reset-button {
            width: 100%;
            margin-top: 20px;
            padding: 12px 20px;
            font-size: 16px;
            background-color: #f44336;
            color: white;
        }
        .reset-button:hover {
            background-color: #d32f2f;
        }
        #copyButton {
            background-color: #008CBA;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        #copyButton:hover {
            background-color: #007B9E;
        }
        .results {
            padding: 25px;
            background-color: #f0f9f0;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
        }
        .results h3 {
            margin-top: 0;
            color: #2e7d32;
            border-bottom: 1px solid #a5d6a7;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item span:first-child {
            font-weight: bold;
            padding-right: 10px;
        }
        .result-item span:last-child {
            color: #0056b3;
            font-weight: bold;
            text-align: right;
        }
        .warning {
            color: #D32F2F;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            padding: 10px;
            background-color: #FFCDD2;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .success {
            color: #388E3C;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            padding: 10px;
            background-color: #C8E6C9;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        #simulationTable {
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: "Courier New", Courier, monospace;
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            overflow-x: auto;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95em;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            color: #555;
        }
        .comparison-table tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
        .comparison-table td:nth-child(2), .comparison-table td:nth-child(3) {
            text-align: right;
            font-weight: bold;
            color: #0056b3;
        }
    details {
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #fdfdfd;
        }
        summary {
            padding: 10px 15px;
            cursor: pointer;
            outline: none;
            font-weight: bold;
            color: #333;
            list-style: none; /* Remove default arrow */
            display: flex;
            align-items: center;
        }
        summary::-webkit-details-marker {
            display: none; /* Remove default arrow for webkit browsers */
        }
        summary::before {
            content: '▶'; /* Custom arrow */
            margin-right: 10px;
            transition: transform 0.2s;
        }
        details[open] summary::before {
            transform: rotate(90deg);
        }
        details h4 { /* Adjust h4 inside summary */
            margin: 0;
            display: inline;
        }
        details > div.result-item { /* Style content inside details */
            padding: 5px 15px;
            border-top: 1px solid #eee;
        }
        details > div.result-item:last-of-type {
            border-bottom: none;
        }
    .simulation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            background-color: #fff;
        }
        .simulation-table th, .simulation-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 10px;
            text-align: left;
        }
        .simulation-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            color: #555;
        }
        .simulation-table tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
        .simulation-table td:nth-child(1) { /* Order count */
            text-align: center;
        }
        .simulation-table td:nth-child(2) { /* Cumulative benefit */
            text-align: right;
            font-weight: bold;
        }
        .simulation-table .status-negative {
            color: #d32f2f; /* Red for negative values */
        }
        .simulation-table .status-recovered {
            color: #388e3c; /* Green for recovered status */
        }
        .simulation-table .recovery-marker {
            font-size: 0.8em;
            color: #0056b3;
            margin-left: 5px;
        }
    #footer-branding {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
            color: #666;
            font-size: 0.9em;
        }
        #footer-branding p {
            margin-bottom: 10px;
        }
        .asahipac-logo {
            max-width: 150px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    <h1>米袋価格メリット計算ツール</h1>

    <div class="main-layout">
        <div class="container">
            <div class="input-section">
                <h3>袋の情報</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label>袋の種類</label>
                        <div style="display: flex; align-items: center; gap: 15px; padding-top: 5px;">
                            <input type="radio" id="bagTypeSingle" name="bagType" value="single">
                            <label for="bagTypeSingle" style="font-weight: normal; margin-bottom: 0;">単袋</label>
                            <input type="radio" id="bagTypeRoll" name="bagType" value="roll" checked>
                            <label for="bagTypeRoll" style="font-weight: normal; margin-bottom: 0;">ロール袋</label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="bagSize">米袋のキロ数</label>
                        <select id="bagSize">
                            <option value="280">1kg (280mm)</option>
                            <option value="320">1.4kg (320mm)</option>
                            <option value="320">1.5kg (320mm)</option>
                            <option value="350">2kg (350mm)</option>
                            <option value="400">3kg (400mm)</option>
                            <option value="450">4kg (450mm)</option>
                            <option value="470" selected>5kg (470mm)</option>
                            <option value="530">8kg (530mm)</option>
                            <option value="570">10kg (570mm)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>袋の長さ</label>
                        <div style="display: flex; align-items: center; gap: 15px; padding-top: 5px;">
                            <input type="radio" id="lengthTypeNormal" name="bagLengthType" value="normal" checked>
                            <label for="lengthTypeNormal" style="font-weight: normal; margin-bottom: 0;">通常</label>
                            <input type="radio" id="lengthTypeEco" name="bagLengthType" value="eco">
                            <label for="lengthTypeEco" style="font-weight: normal; margin-bottom: 0;" title="選択すると、米袋の長さが30mm短くなります。">エコ（-30mm）</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3>価格関係</h3>
                <div class="input-grid price-layout">
                    <div class="price-column">
                        <h4>現行品</h4>
                        <div class="input-group">
                            <label for="currentPrice">単価（円）</label>
                            <input type="number" id="currentPrice" placeholder="単価：現行品">
                        </div>
                    </div>
                    <div class="price-column">
                        <h4>ご提案の米袋</h4>
                        <div class="input-group">
                            <label for="newBagPrice">単価（円）</label>
                            <input type="number" id="newBagPrice" placeholder="単価：ご提案の米袋">
                        </div>
                        <div class="input-group">
                            <label for="newBagCost">原価（円）</label>
                            <input type="number" id="newBagCost" placeholder="原価：ご提案の米袋">
                        </div>
                    </div>
                    <div class="price-column">
                        <h4>製版代</h4>
                        <div class="input-group">
                            <label for="plateCost">単価（円/版）</label>
                            <input type="number" id="plateCost" placeholder="製版代の単価">
                        </div>
                        <div class="input-group">
                            <label for="plateCostPrice">原価（円/版）</label>
                            <input type="number" id="plateCostPrice" placeholder="製版代の原価">
                        </div>
                        <div class="input-group">
                            <label for="plateCount">製版数</label>
                            <select id="plateCount">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3>数量関係</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="annualUsage">年間使用量 <span class="unit-spec">(m数で記載)</span></label>
                        <div class="stepper">
                            <button type="button" onclick="decrementAnnualUsage()">-</button>
                            <input type="number" id="annualUsage" value="4000" readonly>
                            <button type="button" onclick="incrementAnnualUsage()">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="orderVolumeMeters">1回の発注m数</label>
                        <div class="stepper">
                            <button type="button" onclick="decrementOrderVolume()">-</button>
                            <input type="number" id="orderVolumeMeters" value="4000" readonly>
                            <button type="button" onclick="incrementOrderVolume()">+</button>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="reset-button" onclick="resetForm()">リセット</button>
        </div>

        <div id="results" class="results" style="display: none;">
            <div id="recoveryCheck"></div>
            <h3>計算結果</h3>
            <div id="result-output"></div>
            <button id="copyButton" onclick="copyResults()">結果をコピー</button>
            
            <h3>回収シミュレーション（発注回数別累計メリット）</h3>
            <pre id="simulationTable"></pre>
        </div>
    </div>

    <script>
        const MIN_ORDER_LOT_METERS = 4000;

        function incrementAnnualUsage() {
            const input = document.getElementById('annualUsage');
            let currentValue = parseInt(input.value) || 0;
            input.value = currentValue + 4000;
            calculate();
        }

        function decrementAnnualUsage() {
            const input = document.getElementById('annualUsage');
            let currentValue = parseInt(input.value) || 0;
            if (currentValue > 4000) {
                input.value = currentValue - 4000;
                calculate();
            }
        }

        function incrementOrderVolume() {
            const input = document.getElementById('orderVolumeMeters');
            let currentValue = parseInt(input.value) || 0;
            input.value = currentValue + 4000;
            calculate();
        }

        function decrementOrderVolume() {
            const input = document.getElementById('orderVolumeMeters');
            let currentValue = parseInt(input.value) || 0;
            if (currentValue > 4000) {
                input.value = currentValue - 4000;
                calculate();
            }
        }

        function saveInputs() {
            const inputs = {
                bagType: document.querySelector('input[name="bagType"]:checked')?.value,
                bagSize: document.getElementById('bagSize').value,
                bagLengthType: document.querySelector('input[name="bagLengthType"]:checked')?.value,
                currentPrice: document.getElementById('currentPrice').value,
                newBagPrice: document.getElementById('newBagPrice').value,
                newBagCost: document.getElementById('newBagCost').value,
                plateCost: document.getElementById('plateCost').value,
                plateCostPrice: document.getElementById('plateCostPrice').value,
                plateCount: document.getElementById('plateCount').value,
                annualUsage: document.getElementById('annualUsage').value,
                orderVolumeMeters: document.getElementById('orderVolumeMeters').value
            };
            localStorage.setItem('riceBagCalculatorInputs', JSON.stringify(inputs));
        }

        function loadInputs() {
            const savedInputs = localStorage.getItem('riceBagCalculatorInputs');
            if (savedInputs) {
                const inputs = JSON.parse(savedInputs);

                // Restore radio buttons
                if (inputs.bagType) {
                    document.querySelector(`input[name="bagType"][value="${inputs.bagType}"]`).checked = true;
                }
                if (inputs.bagLengthType) {
                    document.querySelector(`input[name="bagLengthType"][value="${inputs.bagLengthType}"]`).checked = true;
                }

                // Restore selects
                if (inputs.bagSize) document.getElementById('bagSize').value = inputs.bagSize;
                if (inputs.plateCount) document.getElementById('plateCount').value = inputs.plateCount;

                // Restore number/text inputs
                if (inputs.currentPrice) document.getElementById('currentPrice').value = inputs.currentPrice;
                if (inputs.newBagPrice) document.getElementById('newBagPrice').value = inputs.newBagPrice;
                if (inputs.newBagCost) document.getElementById('newBagCost').value = inputs.newBagCost;
                if (inputs.plateCost) document.getElementById('plateCost').value = inputs.plateCost;
                if (inputs.plateCostPrice) document.getElementById('plateCostPrice').value = inputs.plateCostPrice;
                if (inputs.annualUsage) document.getElementById('annualUsage').value = inputs.annualUsage;
                if (inputs.orderVolumeMeters) document.getElementById('orderVolumeMeters').value = inputs.orderVolumeMeters;
            }
        }

        function resetForm() {
            // Reset radio buttons and selects
            document.getElementById('bagTypeRoll').checked = true;
            document.getElementById('bagSize').value = '470';
            document.getElementById('lengthTypeNormal').checked = true;
            document.getElementById('plateCount').value = '1';

            // Reset number/text inputs
            document.getElementById('currentPrice').value = '';
            document.getElementById('newBagPrice').value = '';
            document.getElementById('newBagCost').value = '';
            document.getElementById('plateCost').value = '';
            document.getElementById('plateCostPrice').value = '';
            document.getElementById('annualUsage').value = '4000';
            document.getElementById('orderVolumeMeters').value = '4000';

            // Hide and clear results
            document.getElementById('results').style.display = 'none';
            document.getElementById('result-output').innerHTML = '';
            document.getElementById('simulationTable').textContent = '';
            document.getElementById('recoveryCheck').innerHTML = '';
            localStorage.removeItem('riceBagCalculatorInputs'); // Clear saved inputs
        }

        function calculate() {
            // --- Input Values ---
            const bagType = document.querySelector('input[name="bagType"]:checked').value;
            const currentPriceInput = parseFloat(document.getElementById('currentPrice').value) || 0;
            const newBagCostInput = parseFloat(document.getElementById('newBagCost').value) || 0;
            const newBagPriceInput = parseFloat(document.getElementById('newBagPrice').value) || 0;
            let annualUsageInput = parseFloat(document.getElementById('annualUsage').value) || 0;
            const plateCost = parseFloat(document.getElementById('plateCost').value) || 0;
            const plateCostPrice = parseFloat(document.getElementById('plateCostPrice').value) || 0;
            const plateCount = parseInt(document.getElementById('plateCount').value) || 0;
            const orderVolumeMeters = parseFloat(document.getElementById('orderVolumeMeters').value) || 0;

            const bagLengthMM_base = parseInt(document.getElementById('bagSize').value) || 0;
            const bagLengthType = document.querySelector('input[name="bagLengthType"]:checked').value;
            let bagLengthMM = bagLengthMM_base;
            if (bagLengthType === 'eco') {
                bagLengthMM -= 30;
            }

            const bagLengthM = bagLengthMM / 1000;

            let costBenefitLabel = '';
            let costBenefitPerUnit = 0;
            let costBenefitPerMeterForCalc = 0;
            let annualUsageMeters = annualUsageInput;

            if (bagType === 'single') {
                const costBenefitPerPiece = currentPriceInput - newBagPriceInput;
                costBenefitLabel = '1枚あたりのコストメリット額';
                costBenefitPerUnit = costBenefitPerPiece;
                if (bagLengthM > 0) {
                    costBenefitPerMeterForCalc = costBenefitPerPiece / bagLengthM;
                }
                // annualUsageMeters is already annualUsageInput (in meters), no need to multiply by bagLengthM
                // If we need annual usage in pieces, it would be annualUsageInput / bagLengthM
                // For calculations based on meters, annualUsageMeters = annualUsageInput is correct.
            } else { // roll
                const costBenefitPerMeter = currentPriceInput - newBagPriceInput;
                costBenefitLabel = '1mあたりのコストメリット額';
                costBenefitPerUnit = costBenefitPerMeter;
                costBenefitPerMeterForCalc = costBenefitPerMeter;
            }

            // --- Customer Cost Benefit Calculation Logic ---
            const annualCostBenefit = costBenefitPerMeterForCalc * annualUsageMeters;
            const costBenefitPerOrder = costBenefitPerMeterForCalc * orderVolumeMeters;

            // 2. 製版代総額 (顧客の初期投資)
            const totalPlateCost = plateCost * plateCount;

            // 3. 年間発注回数
            const annualOrderCount = annualUsageMeters > 0 && orderVolumeMeters > 0 ? annualUsageMeters / orderVolumeMeters : 0;

            // 4. 初期投資（製版代）の回収に必要な発注回数
            const recoveryOrdersDecimal = costBenefitPerOrder > 0 ? totalPlateCost / costBenefitPerOrder : Infinity;
            const recoveryStartOrder = Math.ceil(recoveryOrdersDecimal);

            // --- Seller Profit Calculation (for reference) ---
            const grossProfitPerUnit = newBagPriceInput - newBagCostInput;
            const grossProfitPerOrder = grossProfitPerUnit * orderVolumeMeters;
            const profitRate = newBagPriceInput > 0 ? (grossProfitPerUnit / newBagPriceInput) * 100 : 0;
            const annualGrossProfit = grossProfitPerUnit * annualUsageMeters;

            // Add plate gross profit calculation
            const plateGrossProfit = (plateCost - plateCostPrice) * plateCount;
            const totalSellerProfit = annualGrossProfit + plateGrossProfit; // New calculation

            // New calculations for totals
            const currentOrderTotal = currentPriceInput * orderVolumeMeters;
            const currentAnnualTotal = currentPriceInput * annualUsageMeters;
            const newBagOrderTotal = newBagPriceInput * orderVolumeMeters;
            const newBagOrderTotalWithPlate = newBagOrderTotal + totalPlateCost;
            const newBagAnnualTotal = newBagPriceInput * annualUsageMeters;

            // --- Operational Info ---
            const pricePerBag = newBagPriceInput * (bagType === 'single' ? 1 : bagLengthM);
            const bagsInOrderVolume = orderVolumeMeters > 0 && bagLengthM > 0 ? orderVolumeMeters / bagLengthM : 0;


            // --- Display Results ---
            document.getElementById('results').style.display = 'block';

            // 1. 回収期間チェック
            const recoveryCheckDiv = document.getElementById('recoveryCheck');
            if (isFinite(recoveryOrdersDecimal) && recoveryOrdersDecimal > annualOrderCount) {
                recoveryCheckDiv.innerHTML = `<div class="warning">【警告】製版代の回収に1年以上かかる見込みです（回収に必要な発注回数が年間発注回数を上回っています）。</div>`;
            } else if (isFinite(recoveryOrdersDecimal)) {
                recoveryCheckDiv.innerHTML = `<div class="success">【達成】1年以内の製版代回収が見込めます。</div>`;
            } else {
                recoveryCheckDiv.innerHTML = ''; // Clear if no benefit
            }

            // 2. 計算結果
            const outputDiv = document.getElementById('result-output');
            outputDiv.innerHTML = `
                <div class="result-item" style="background-color: #e8f5e9; padding: 10px; border-radius: 4px;">
                    <span style="font-size: 1.2em;">年間コストメリット総額</span>
                    <span style="font-size: 1.2em; color: #2e7d32;">${annualCostBenefit.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</span>
                </div>
                <div class="result-item"><span>${costBenefitLabel}</span> <span>${costBenefitPerUnit.toFixed(2)} 円</span></div>
                <div class="result-item"><span>1回の発注あたりのコストメリット額</span> <span>${costBenefitPerOrder.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</span></div>
                <div class="result-item"><span>製版代総額（初期投資）</span> <span>${totalPlateCost.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</span></div>
                
                <div class="result-item"><span>初期投資回収完了の発注回数</span> <span>${isFinite(recoveryStartOrder) ? recoveryStartOrder + ' 回目' : 'N/A'}</span></div>
                <hr>
                <h3>合計金額情報</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>現行品</th>
                            <th>ご提案の米袋</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1回の発注合計</td>
                            <td>${currentOrderTotal.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</td>
                            <td>${newBagOrderTotal.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</td>
                        </tr>
                        <tr>
                            <td>1回の発注合計（製版代含む）</td>
                            <td>-</td>
                            <td>${newBagOrderTotalWithPlate.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</td>
                        </tr>
                        <tr>
                            <td>年間合計</td>
                            <td>${currentAnnualTotal.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</td>
                            <td>${newBagAnnualTotal.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</td>
                        </tr>
                    </tbody>
                </table>
                <hr>
                <h3>詳細情報</h3>
                <h4>運用情報</h4>
                <div class="result-item"><span>年間発注回数</span> <span>${annualOrderCount.toFixed(1)} 回</span></div>
                <div class="result-item"><span>1枚あたりの参考価格（製版代含まず）</span> <span>${pricePerBag.toFixed(2)} 円</span></div>
                <div class="result-item"><span>1回あたりの発注総数</span> <span>${orderVolumeMeters}m / ${Math.floor(bagsInOrderVolume).toLocaleString()} 枚</span></div>
                <details>
                    <summary><h4>販売者利益</h4></summary>
                    <div class="result-item"><span>1回の発注あたりの粗利</span> <span>${grossProfitPerOrder.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</span></div>
                    <div class="result-item"><span>粗利（円/m）</span> <span>${grossProfitPerUnit.toFixed(2)}</span></div>
                    <div class="result-item"><span>粗利率（％）</span> <span>${profitRate.toFixed(2)} %</span></span></div>
                    <div class="result-item"><span>年間粗利総額（ご提案の米袋販売）</span> <span>${annualGrossProfit.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</span></div>
                    <div class="result-item"><span>製版代の粗利</span> <span>${plateGrossProfit.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</span></div>
                    <div class="result-item" style="background-color: #e8f5e9; padding: 10px; border-radius: 4px;">
                        <span style="font-size: 1.2em;">販売者総粗利</span>
                        <span style="font-size: 1.2em; color: #2e7d32;">${totalSellerProfit.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</span>
                    </div>
                </details>
            `;
            
            // --- Simulation Table ---
            generateSimulationTable(costBenefitPerOrder, totalPlateCost, recoveryStartOrder, annualOrderCount);
            saveInputs(); // Save inputs after calculation
        }

        function generateSimulationTable(costBenefitPerOrder, totalCost, recoveryStartOrder, annualOrderCount) {
            if (!isFinite(recoveryStartOrder)) {
                document.getElementById('simulationTable').innerHTML = '<p>コストメリットがないため、シミュレーションは表示できません。</p>';
                return;
            }

            let tableHtml = '<table class="simulation-table"><thead><tr><th>発注回数</th><th>累計メリット額</th><th>状態</th></tr></thead><tbody>';
            let cumulativeBenefit = -totalCost; // Start from negative total plate cost

            const maxOrders = Math.max(18, Math.ceil(annualOrderCount) + 6, recoveryStartOrder + 6); 

            for (let order = 1; order <= maxOrders; order++) {
                cumulativeBenefit += costBenefitPerOrder;
                let status = '回収中';
                let statusClass = '';
                if (order >= recoveryStartOrder) {
                    status = '✅ 回収完了';
                    statusClass = 'status-recovered';
                } else if (cumulativeBenefit < 0) {
                    statusClass = 'status-negative';
                }

                tableHtml += `<tr>`;
                tableHtml += `<td>${order}</td>`;
                tableHtml += `<td class="${statusClass}">${cumulativeBenefit.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY' })}</td>`;
                tableHtml += `<td class="${statusClass}">${status}${order === recoveryStartOrder ? '  <span class="recovery-marker">← 回収完了</span>' : ''}</td>`;
                tableHtml += `</tr>`;
            }
            tableHtml += '</tbody></table>';
            document.getElementById('simulationTable').innerHTML = tableHtml;
        }

        function copyResults() {
            const resultsDiv = document.getElementById('results');
            const recoveryCheckText = resultsDiv.querySelector('#recoveryCheck div') ? resultsDiv.querySelector('#recoveryCheck div').innerText : '（メリットなし）';
            
            let markdownToCopy = `## 米袋価格メリット計算結果\n\n`;
            markdownToCopy += `**${recoveryCheckText}**\n\n`;
            
            const outputDiv = document.getElementById('result-output');
            
            // Function to extract text from result-item
            const extractResultItem = (node) => {
                const title = node.children[0].innerText.trim();
                const value = node.children[1].innerText.trim();
                return { title, value };
            };

            outputDiv.childNodes.forEach(node => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.tagName === 'H3') {
                        markdownToCopy += `### ${node.innerText.trim()}\n\n`;
                    } else if (node.tagName === 'H4') {
                        markdownToCopy += `#### ${node.innerText.trim()}\n\n`;
                    } else if (node.classList.contains('result-item')) {
                        const { title, value } = extractResultItem(node);
                        markdownToCopy += `- **${title}**: ${value}\n`;
                    } else if (node.tagName === 'TABLE' && node.classList.contains('comparison-table')) {
                        // Handle comparison table
                        const headers = Array.from(node.querySelectorAll('thead th')).map(th => th.innerText.trim());
                        const rows = Array.from(node.querySelectorAll('tbody tr')).map(tr => {
                            return Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim());
                        });

                        markdownToCopy += `| ${headers.join(' | ')} |\n`;
                        markdownToCopy += `|${'---'.repeat(headers.length).split('').join('|')}|\n`; // Generate separator line
                        rows.forEach(row => {
                            markdownToCopy += `| ${row.join(' | ')} |\n`;
                        });
                        markdownToCopy += '\n';
                    }
                }
            });

            // Handle simulation table
            const simulationTableElement = document.getElementById('simulationTable');
            if (simulationTableElement && simulationTableElement.querySelector('table')) {
                markdownToCopy += `### 回収シミュレーション (発注回数別累計メリット)\n\n`;
                const simTable = simulationTableElement.querySelector('table');
                const simHeaders = Array.from(simTable.querySelectorAll('thead th')).map(th => th.innerText.trim());
                const simRows = Array.from(simTable.querySelectorAll('tbody tr')).map(tr => {
                    return Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim());
                });

                markdownToCopy += `| ${simHeaders.join(' | ')} |\n`;
                markdownToCopy += `|${'---'.repeat(simHeaders.length).split('').join('|')}|\n`; // Generate separator line
                simRows.forEach(row => {
                    markdownToCopy += `| ${row.join(' | ')} |\n`;
                });
                markdownToCopy += '\n';
            } else if (simulationTableElement && simulationTableElement.querySelector('p')) {
                 markdownToCopy += `### 回収シミュレーション (発注回数別累計メリット)\n\n`;
                 markdownToCopy += simulationTableElement.querySelector('p').innerText.trim() + '\n\n';
            }


            navigator.clipboard.writeText(markdownToCopy).then(() => {
                alert('計算結果をクリップボードにMarkdown形式でコピーしました。');
            }).catch(err => {
                console.error('コピーに失敗しました: ', err);
                alert('コピーに失敗しました。');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const idsToWatch = [
                'bagTypeSingle', 'bagTypeRoll', 'bagSize', 'currentPrice', 'newBagCost', 
                'newBagPrice', 'plateCost', 'plateCostPrice', 'plateCount', 
                'annualUsage', 'lengthTypeNormal', 'lengthTypeEco'
            ];

            idsToWatch.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const eventType = (element.type === 'radio' || element.tagName.toLowerCase() === 'select') ? 'change' : 'input';
                    element.addEventListener(eventType, calculate);
                }
            });

            loadInputs(); // Load inputs from localStorage
            // Run initial calculation on page load to handle default values
            calculate();
        });

    </script>
    <div id="footer-branding">
        <p>提供：</p>
        <a href="https://www.asahipac.co.jp/" target="_blank" rel="noopener noreferrer">
            <img src="https://www.asahipac.co.jp/cms/wp-content/themes/asahipac/images/logo.png" alt="Asahipac Logo" class="asahipac-logo">
        </a>
    </div>
</body>
</html>
